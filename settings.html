<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GeminiDesk Settings</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');
        
        :root {
            --bg-primary: #1e1e1e; --bg-secondary: #252526; --bg-tertiary: #2d2d30;
            --text-primary: #cccccc; --text-secondary: #9e9e9e; --accent-primary: #0e98d9;
            --accent-secondary: #3c3c3c; --danger-color: #f44336; --success-color: #4caf50;
            --border-color: #3e3e42;
        }

        html, body {
            margin: 0; padding: 0; background-color: var(--bg-primary);
            color: var(--text-primary); font-family: 'Poppins', sans-serif;
            overflow: hidden; -webkit-font-smoothing: antialiased; user-select: none;
        }

        .drag-bar {
            width: 100%; height: 40px; -webkit-app-region: drag; background-color: var(--bg-secondary);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; box-sizing: border-box; border-bottom: 1px solid var(--border-color);
        }

        .drag-bar h2 { font-size: 16px; margin: 0; font-weight: 500; color: var(--text-primary); -webkit-app-region: drag; }

        #close-button {
            -webkit-app-region: no-drag; font-size: 22px; background: none; border: none;
            color: var(--text-secondary); cursor: pointer; transition: transform .2s ease, color .2s ease;
            padding: 5px; line-height: 1;
        }
        #close-button:hover { transform: rotate(90deg); color: var(--accent-primary); }

        .content { padding: 20px; overflow-y: auto; height: calc(100vh - 40px); }
        .content::-webkit-scrollbar { width: 8px; }
        .content::-webkit-scrollbar-track { background: var(--bg-primary); }
        .content::-webkit-scrollbar-thumb { background-color: var(--accent-secondary); border-radius: 4px; }

        .setting-category { margin-bottom: 30px; }
        .setting-category-title {
            font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: var(--accent-primary); margin-bottom: 15px; padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color); display: flex; align-items: center;
        }
        .setting-category-title svg { width: 16px; height: 16px; margin-right: 8px; }

        .setting-item {
            background-color: var(--bg-secondary); border-radius: 8px; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; border: 1px solid var(--border-color);
            transition: border-color .2s ease, box-shadow .2s ease;
        }
        .setting-item:hover { border-color: var(--accent-secondary); }
        
        .setting-label { display: flex; flex-direction: column; }
        .setting-label strong { font-weight: 500; font-size: 14px; }
        .setting-label span { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle-switch input { display: none; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--accent-secondary); transition: .3s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: #fff; transition: .3s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        .record-button, .action-button {
            background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 8px 12px; border-radius: 6px; cursor: pointer; font-family: 'Poppins', sans-serif;
            font-size: 13px; min-width: 130px; text-align: center; transition: all .2s ease;
        }
        .record-button:hover, .action-button:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .record-button.is-recording { background-color: var(--accent-primary); border-color: var(--accent-primary); color: #fff; font-weight: 600; cursor: default; }

        #reset-button {
            border: 1px solid var(--danger-color); background: transparent; color: var(--danger-color);
            padding: 8px 15px; border-radius: 6px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: background-color .2s, color .2s;
            font-family: 'Poppins', sans-serif;
        }
        #reset-button:hover { background-color: var(--danger-color); color: #fff; }

        #notification-status-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-right: 15px;
            min-width: 100px;
            text-align: left;
            transition: opacity 0.3s ease;
        }
        
        #update-status-text { 
            font-size: 12px; 
            color: var(--text-secondary); 
            margin-left: 15px; 
            min-width: 100px; 
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="drag-bar">
        <h2>Settings</h2>
        <button id="close-button" title="Close">&times;</button>
    </div>
    <div class="content">
        <div class="setting-category">
            <h3 class="setting-category-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.9142 9.40429C19.9142 9.13571 19.9429 8.87143 19.9857 8.60286L21.6571 7.25286C21.8429 7.09714 21.8857 6.83286 21.7857 6.61857L20.2286 3.97714C20.1286 3.76286 19.8857 3.65571 19.6714 3.72571L17.6571 4.52286C17.1143 4.11143 16.5286 3.76286 15.9 3.48571L15.5857 1.32571C15.5571 1.09714 15.3571 0.928571 15.1143 0.928571H11.8857C11.6429 0.928571 11.4429 1.09714 11.4143 1.32571L11.1 3.48571C10.4714 3.76286 9.88571 4.11143 9.34286 4.52286L7.32857 3.72571C7.11429 3.65571 6.87143 3.76286 6.77143 3.97714L5.21429 6.61857C5.11429 6.83286 5.15714 7.09714 5.34286 7.25286L7.01429 8.60286C6.97143 8.87143 6.94286 9.13571 6.94286 9.40429C6.94286 9.67286 6.97143 9.93714 7.01429 10.2057L5.34286 11.5557C5.15714 11.7114 5.11429 11.9757 5.21429 12.19L6.77143 14.8314C6.87143 15.0457 7.11429 15.1529 7.32857 15.0829L9.34286 14.2857C9.88571 14.6971 10.4714 15.0457 11.1 15.3229L11.4143 17.4829C11.4429 17.7114 11.6429 17.88 11.8857 17.88H15.1143C15.3571 17.88 15.5571 17.7114 15.5857 17.4829L15.9 15.3229C16.5286 15.0457 17.1143 14.6971 17.6571 14.2857L19.6714 15.0829C19.8857 15.1529 20.1286 15.0457 20.2286 14.8314L21.7857 12.19C21.8857 11.9757 21.8429 11.7114 21.6571 11.5557L19.9857 10.2057C19.9429 9.93714 19.9142 9.67286 19.9142 9.40429ZM13.5 12.4343C11.5286 12.4343 9.94286 10.8486 9.94286 8.87714C9.94286 6.90571 11.5286 5.32 13.5 5.32C15.4714 5.32 17.0571 6.90571 17.0571 8.87714C17.0571 10.8486 15.4714 12.4343 13.5 12.4343Z"></path></svg>
                General
            </h3>
            <div class="setting-item">
                <div class="setting-label"><strong>Application Updates</strong><span>Check for the latest version.</span></div>
                <div style="display: flex; align-items: center;">
                    <button id="manual-check-for-updates-button" class="action-button">Check for Updates</button>
                </div>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>Run on System Startup</strong><span>Start GeminiDesk automatically.</span></div>
                <label class="toggle-switch"><input type="checkbox" id="setting-autoStart"><span class="slider"></span></label>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>Always on Top</strong><span>Keep the window above others.</span></div>
                <label class="toggle-switch"><input type="checkbox" id="setting-alwaysOnTop"><span class="slider"></span></label>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>Automatic Canvas Resizing</strong><span>Resize the canvas when needed.</span></div>
                <label class="toggle-switch"><input type="checkbox" id="setting-enableCanvasResizing"><span class="slider"></span></label>
            </div>
        </div>
        <div class="setting-category">
            <h3 class="setting-category-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                Notifications
            </h3>
            <div class="setting-item">
                <div class="setting-label"><strong>Automatic Daily Check</strong><span>Check for new messages once a day.</span></div>
                <label class="toggle-switch"><input type="checkbox" id="setting-autoCheckNotifications"><span class="slider"></span></label>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>Manual Check</strong><span>Check for new messages now.</span></div>
                <button id="check-for-notifications-button" class="action-button">Check Now</button>
            </div>
        </div>
        <div class="setting-category">
            <h3 class="setting-category-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 5H4C2.89543 5 2 5.89543 2 7V17C2 18.1046 2.89543 19 4 19H20C21.1046 19 22 18.1046 22 17V7C22 5.89543 21.1046 5 20 5ZM11 16H4V14H11V16ZM14.5 16H12.5V14H14.5V16ZM11 13H4V11H11V13ZM11 10H4V8H11V10ZM16.5 16H18.5C18.7761 16 19 15.7761 19 15.5V14.5C19 14.2239 18.7761 14 18.5 14H16.5C16.2239 14 16 14.2239 16 14.5V15.5C16 15.7761 16.2239 16 16.5 16ZM15.5 13H12.5V11H15.5V13ZM18.5 13H16.5V11H18.5V13ZM20 10H12V8H20V10Z"></path></svg>
                Shortcuts
            </h3>
            <div class="setting-item">
                <div class="setting-label"><strong>Show / Hide Window</strong><span>Toggle window visibility.</span></div>
                <button class="record-button" data-key="showHide">Click to record</button>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>Open New Window</strong><span>Creates a new, separate window.</span></div>
                <button class="record-button" data-key="newWindow">Click to record</button>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>Quit Application</strong><span>Close the application.</span></div>
                <button class="record-button" data-key="quit">Click to record</button>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>Show Instructions</strong><span>See the welcome screen.</span></div>
                <button class="record-button" data-key="showInstructions">Click to record</button>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>Refresh Window</strong><span>Reloads the current page content.</span></div>
                <button class="record-button" data-key="refresh">Click to record</button>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>Search Chats</strong><span>Focus the chat search bar.</span></div>
                <button class="record-button" data-key="search">Click to record</button>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>Take Screenshot & Paste</strong><span>Copies screen area to clipboard and pastes it.</span></div>
                <button class="record-button" data-key="screenshot">Click to record</button>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>New Chat (Pro)</strong><span>Starts a new chat with the Pro model.</span></div>
                <button class="record-button" data-key="newChatPro">Click to record</button>
            </div>
            <div class="setting-item">
                <div class="setting-label"><strong>New Chat (Flash)</strong><span>Starts a new chat with the Flash model.</span></div>
                <button class="record-button" data-key="newChatFlash">Click to record</button>
            </div>
        </div>
        <div class="setting-category">
            <h3 class="setting-category-title" style="color: var(--danger-color);">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></svg>
                Danger Zone
            </h3>
            <div class="setting-item">
                <div class="setting-label"><strong>Reset All Settings</strong><span>This action cannot be undone.</span></div>
                <button id="reset-button">Reset</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Check if electronAPI exists (for Electron environment)
    if (!window.electronAPI) { 
        console.warn('electronAPI not available - running in browser mode');
        // Initialize with default values for testing
        initializeBrowserMode();
        return; 
    }
    
    const electronAPI = window.electronAPI;

    // --- Sync UI with settings ---
    const syncUi = (settings) => {
        try {
            document.getElementById('setting-autoStart').checked = settings.autoStart || false;
            document.getElementById('setting-alwaysOnTop').checked = settings.alwaysOnTop || false;
            document.getElementById('setting-autoCheckNotifications').checked = settings.autoCheckNotifications || false;
            document.getElementById('setting-enableCanvasResizing').checked = settings.enableCanvasResizing || false;
            
            // Update shortcut buttons
            document.querySelectorAll('.record-button').forEach(button => {
                const key = button.dataset.key;
                if(settings.shortcuts && settings.shortcuts[key]) {
                    button.textContent = settings.shortcuts[key];
                } else {
                    button.textContent = 'Click to record';
                }
            });
        } catch (error) {
            console.error('Error syncing UI:', error);
        }
    };

    // Initialize settings
    electronAPI.getSettings().then(syncUi).catch(error => {
        console.error('Error getting settings:', error);
    });
    
    electronAPI.onSettingsUpdated(syncUi);

    // --- General Event Listeners ---
    document.getElementById('close-button').addEventListener('click', () => {
        if (window.close) {
            window.close();
        } else {
            electronAPI.closeWindow();
        }
    });
    
    document.getElementById('reset-button').addEventListener('click', () => {
        electronAPI.showConfirmReset();
    });
    
    // --- Toggle Switches ---
    document.getElementById('setting-autoStart').addEventListener('change', (e) => {
        electronAPI.updateSetting('autoStart', e.target.checked);
    });
    
    document.getElementById('setting-alwaysOnTop').addEventListener('change', (e) => {
        electronAPI.updateSetting('alwaysOnTop', e.target.checked);
    });
    
    document.getElementById('setting-autoCheckNotifications').addEventListener('change', (e) => {
        electronAPI.updateSetting('autoCheckNotifications', e.target.checked);
    });
    
    document.getElementById('setting-enableCanvasResizing').addEventListener('change', (e) => {
        electronAPI.updateSetting('enableCanvasResizing', e.target.checked);
    });

    // --- Manual Action Buttons ---
    document.getElementById('manual-check-for-updates-button').addEventListener('click', () => {
        electronAPI.checkForUpdates();
    });

    document.getElementById('check-for-notifications-button').addEventListener('click', () => {
        electronAPI.manualCheckForNotifications();
    });

    // --- Shortcut Recording Logic ---
    let isRecording = false;
    
    const startRecording = (button) => {
        if (isRecording) return;
        
        isRecording = true;
        const originalText = button.textContent;
        const pressedKeys = new Set();
        
        button.textContent = 'Recording...';
        button.classList.add('is-recording');
        
        const cleanup = () => {
            document.removeEventListener('keydown', keydownHandler, true);
            document.removeEventListener('keyup', keyupHandler, true);
            button.classList.remove('is-recording');
            isRecording = false;
        };
        
        const keydownHandler = (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Add modifier keys
            if (e.ctrlKey) pressedKeys.add('Control');
            if (e.altKey) pressedKeys.add('Alt');
            if (e.shiftKey) pressedKeys.add('Shift');
            if (e.metaKey) pressedKeys.add('Super');
            
            // Add the actual key (avoid adding modifier keys twice)
            if (!['Control', 'Alt', 'Shift', 'Meta'].includes(e.key)) {
                const keyCode = e.code.replace('Key', '').replace('Digit', '');
                pressedKeys.add(keyCode);
            }
            
            // Update button text with current combination
            button.textContent = Array.from(pressedKeys).join('+');
        };
        
        const keyupHandler = (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Cancel recording on Escape
            if (e.key === 'Escape') {
                button.textContent = originalText;
                cleanup();
                return;
            }
            
            const finalShortcut = Array.from(pressedKeys).join('+');
            
            // Only save if we have a valid combination (more than just modifier keys)
            if (pressedKeys.size > 1 && finalShortcut !== 'Control+Alt+Shift') {
                button.textContent = finalShortcut;
                electronAPI.updateSetting(`shortcuts.${button.dataset.key}`, finalShortcut);
            } else {
                button.textContent = originalText;
            }
            
            cleanup();
        };
        
        // Add event listeners
        document.addEventListener('keydown', keydownHandler, true);
        document.addEventListener('keyup', keyupHandler, true);
    };

    // Add click handlers to all record buttons
    document.querySelectorAll('.record-button').forEach(button => {
        button.addEventListener('click', () => startRecording(button));
    });
});

// Initialize browser mode for testing without Electron
function initializeBrowserMode() {
    console.log('Initializing browser mode');
    
    // Mock settings for testing
    const mockSettings = {
        autoStart: false,
        alwaysOnTop: false,
        autoCheckNotifications: true,
        enableCanvasResizing: true,
        shortcuts: {
            showHide: 'Control+Space',
            newWindow: 'Control+N',
            quit: 'Control+Q',
            showInstructions: 'F1',
            refresh: 'F5',
            search: 'Control+F',
            screenshot: 'Control+Shift+S',
            newChatPro: 'Control+Shift+P',
            newChatFlash: 'Control+Shift+F'
        }
    };
    
    // Update UI with mock settings
    document.getElementById('setting-autoStart').checked = mockSettings.autoStart;
    document.getElementById('setting-alwaysOnTop').checked = mockSettings.alwaysOnTop;
    document.getElementById('setting-autoCheckNotifications').checked = mockSettings.autoCheckNotifications;
    document.getElementById('setting-enableCanvasResizing').checked = mockSettings.enableCanvasResizing;
    
    document.querySelectorAll('.record-button').forEach(button => {
        const key = button.dataset.key;
        if(mockSettings.shortcuts[key]) {
            button.textContent = mockSettings.shortcuts[key];
        }
    });
    
    // Add mock event handlers
    document.getElementById('close-button').addEventListener('click', () => {
        alert('Close button clicked (browser mode)');
    });
    
    document.getElementById('reset-button').addEventListener('click', () => {
        alert('Reset button clicked (browser mode)');
    });
    
    document.getElementById('manual-check-for-updates-button').addEventListener('click', () => {
        alert('Check for updates clicked (browser mode)');
    });
    
    document.getElementById('check-for-notifications-button').addEventListener('click', () => {
        alert('Check notifications clicked (browser mode)');
    });
    
    // Add shortcut recording for browser mode
    let isRecording = false;
    
    const startRecording = (button) => {
        if (isRecording) return;
        
        isRecording = true;
        const originalText = button.textContent;
        const pressedKeys = new Set();
        
        button.textContent = 'Recording...';
        button.classList.add('is-recording');
        
        const cleanup = () => {
            document.removeEventListener('keydown', keydownHandler, true);
            document.removeEventListener('keyup', keyupHandler, true);
            button.classList.remove('is-recording');
            isRecording = false;
        };
        
        const keydownHandler = (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (e.ctrlKey) pressedKeys.add('Control');
            if (e.altKey) pressedKeys.add('Alt');
            if (e.shiftKey) pressedKeys.add('Shift');
            if (e.metaKey) pressedKeys.add('Super');
            
            if (!['Control', 'Alt', 'Shift', 'Meta'].includes(e.key)) {
                const keyCode = e.code.replace('Key', '').replace('Digit', '');
                pressedKeys.add(keyCode);
            }
            
            button.textContent = Array.from(pressedKeys).join('+');
        };
        
        const keyupHandler = (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (e.key === 'Escape') {
                button.textContent = originalText;
                cleanup();
                return;
            }
            
            const finalShortcut = Array.from(pressedKeys).join('+');
            
            if (pressedKeys.size > 1) {
                button.textContent = finalShortcut;
                console.log(`Shortcut recorded for ${button.dataset.key}: ${finalShortcut}`);
            } else {
                button.textContent = originalText;
            }
            
            cleanup();
        };
        
        document.addEventListener('keydown', keydownHandler, true);
        document.addEventListener('keyup', keyupHandler, true);
    };

    document.querySelectorAll('.record-button').forEach(button => {
        button.addEventListener('click', () => startRecording(button));
    });
}
</script>
</body>
</html>
